# 2-2. 스케줄링(Scheduling)

## 테인트(Taints) & 톨러레이션(Tolerations)

+ 특정 pod가 특정 노드에 스케줄링 되도록/되지 않도록 제한할때 사용됨

+ 테인트(Taints) → 노드에 설정 / 톨러레이션(Tolerations) → pod에 설정

+ 특정 노드에 배포하고 싶은 경우, `nodeSelector`를 사용해야 함

  <img src="https://user-images.githubusercontent.com/33214969/161413302-f74b376a-cba0-4bc1-b745-319396f161f4.png" alt="스케줄링 - 테인트:톨러레이션1.png" width="50%;" />

  > + Node 1에 `taint=blue` 적용 → tolerations이 없는 pod A, B, C는 Node 1에 스케줄링 되지 X
  > + pod D에 toleration 적용 → Node 1에 스케줄링될 수 있음. 단, 반드시 Node 1에 배치되는 것은 X

### 테인트(Taints)

+ Node에 적용됨

+ Taint 적용 명령어 : 

  ```
  kubectl taint node [node명] [key]=[value]:[effect]
  ```

  + effect : Taints를 Tolerate하지 못하는 pod들이 취해야 할 행동
    + `NoSchedule` : 앞으로 이 노드에 스케줄링 되지 X
    + `PreferNoSchedule` : 최대한 이 노드에 스케줄링 되지 않도록 하지만 보장되진 X
    + `NoExecute` : 현재 배치된 pod들도 확인 후 조건에 맞지 않으면 내쫓음

+ 관련 명령어

  + Taint 설정 : `kubectl taint node [node명] [key]=[value]:[effect]`
  + Taint 확인 : `kubectl describe nodes [node명] | grep Taint`
  + (master에 대한) Taint 삭제 : `kubectl taint nodes [node명] node-role.kubenetes.io/master-`
  + Taint 삭제 : `kubectl taint nodes [node명] [key]=[value]:[effect]`

### 톨러레이션(Tolerations)

+ Pod에 적용됨

+ Taints가 설정된 노드에 스케줄링하기 위해 pod에 Tolerations 설정 필요

+ yaml 파일

  ```yaml
  # pod-definition.yml
  apiVersion:
  kind: Pod
  metadata:
    name: myapp-pod
  spec:
    containers:
    - name: nginx-container
      image: nginx
    tolerations:
    - key: "app"
      operator: "Equal"
      value: "blue"
      effect: "NoSchedule"
  ```

  + key : Taints 설정했던 key 값
  + value : Taints 설정했던 value 값
  + operator : Toleration을 어떤 조건에 의해 설정할 것인지
    + `Equal` : key, value, effect 필드 값이 Taints와 모두 같은지 확인
    + `Exists` : Taints 설정과 관련 없이 pod를 스케줄링하여 실행
  + effect : pod를 스케줄링할 조건
    + `NoSchedule` : Tolerations이 없다면 스케줄링 X
    + `PreferNoSchedule` : Tolerations이 없다면 스케줄링 X + 클러스터 안의 자원이 부족할 경우, Taints를 설정한 노드에서도 pod를 스케줄링 O
    + `NoExecute` : Tolerations이 없다면 스케줄링 X + 기존에 배포되어 있는 pod들도 Tolerations이 없다면 종료시킴

<br/>

## 노드 셀렉터(Node Selectors)

+ pod를 특정 노드에 배치하고 싶을 때 사용함

+ yaml 파일의 `spec`에 `nodeSelector`를 추가 → 노드의 `label` 항목과 매칭시킴

+ 노드 선택 조건이 복잡한 경우(OR or NOT과 같은 경우) 노드 셀렉터로는 처리하기 어려움 → 이런 경우, 노드 어피니티(Affinity) or 안티 어피니티(anti affinity)를 사용함

+ yaml 파일

  ```yaml
  #pod-definition.yaml
  apiVersion:
  kind: Pod
  metadata:
    name: myapp-pod
  spec:
    containers:
    - name: data-processor
      image: data-processor
    nodeSelector:
      size: Large
  ```

+ 관련 명령어

  + 노드 레이블 추가 : `kubectl label nodes [node명] [key]=[value]`

<br/><br/>

[참고] https://nopanderer.github.io/kubernetes/2021-07-25-scheduling/<br/>[참고] https://velog.io/@seunghyeon/Kubernetes-5.-파드-스케줄링<br/>[참고] https://freedeveloper.tistory.com/409?category=877486<br/>[참고] https://skasha.tistory.com/92?category=798024<br/>