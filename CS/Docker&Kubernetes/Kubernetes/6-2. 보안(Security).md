# 6-2. 보안(Security)

## Authorization

```tex
▫️ 사용자가 클러스터에 접근하여 할 수 있는 것을 정의함
```

+ 권한 부여 메커니즘

  ### Node authorization

  + kubelet은 apiserver에 접근하여 service, endpoint, node, pod의 정보를 읽거나 node 상태와 같은 정보를 apiserver에 전달함. 이러한 요청은 node authorizer의해 처리됨
  + 사용자 이름이 system:nodes 그룹에 속해야 함

  <br/>

  ### Attribute based authorization

  + 사용자 or 사용자 그룹을 권한 집합과 연결시키는 방법
  + json 형식의 정책 집합 파일을 생성하여 apiserver에 전달함. 변경/추가가 필요할 때마다 파일 수정 후 apiserver를 재시작해야 함.

  <br/>

  ### Role based authorization

  + 권한 집합으로 역할을 생성하여 사용자를 역할에 연결시키는 방법
  + 변경이 필요한 경우 역할을 수정하는 식으로 반영할 수 있음

  <br/>

  ### Webhook

  + 외부에서 인증을 관리하는 방법
  + 사용자 정보와 요청 정보를 이용해 인증 agent의 API를 호출하여 승인 여부를 결정함
  + API response에 기반하여 접근을 제어함

  <br/>

  ### AlwaysAllow

  + 모든 요청을 인증 없이 허용하는 방식

  <br/>

  ### AlwaysDeny

  + 모든 요청을 거부하는 방식

  <br/>

+ 권한 부여 메커니즘은 kube-apiserver에서 `--authorization-mode` 옵션을 사용하여 설정(default : AlwaysAllow)

  + 메커니즘은 쉼표로 구분하여 여러 메커니즘 사용하도록 설정 가능함 → 선언된 순서대로 동작함

  + 요청을 거부하면 다음 승인 메커니즘이 동작하며, 요청을 승인하면 다음 인증 메커니즘은 동작하지 않음

  + yaml 파일

    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
      creationTimestamp: null
      name: kube-apiserver
      namespace: kube-system
    spec:
      containers:
      - command:
        - kube-apiserver
        - --authorization-mode=Node,RBAC    # 권한 부여 메커니즘 설정
        ...
    ```

<br/>

## RBAC(Role Based Access Controls)

### Role

+ 하나의 Role은 여러 규칙을 가질 수 있음

+ 하나의 Role은 접근을 허용할 apiGroup, resources, verbs(자원에 허용할 작업)으로 이루어져 있음

  + yaml 파일

    ```yaml
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: developer
    rules:
    - apiGroups: [""]
      resources: ["pods"]   # 권한을 부여할 자원
      verbs: ["list", "get", "create", "update", "delete"]   # 작업
    - apiGroups: [""]       # 다른 규칙
      resources: ["ConfigMap"]
      verbs: ["create"]
    ```

  + 관련 명령어

    + Role 생성 : `kubectl create -f [Role yaml 파일명].yaml` / `kubectl create role [role명] --namespace=[namespace명] --verb=[verb 리스트] --resource=[resource 리스트]`
    + Role 수정 : `kubectl edit role [role명] -n [namespace명]` → yaml 파일 수정
    + Role 목록 조회 : `kubectl get roles`
    + Role 상세 조회 : `kubectl describe role [Role명]`

### resourceNames

+ resource 중에서 특정 resource에 대한 접근만 허용할 때 사용함

  + yaml 파일

    ```yaml
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: developer
    rules:
    - apiGroups: [""]
      resources: ["pods"]     # 권한을 부여할 자원
      verbs: ["list", "get", "create", "update", "delete"]    # 작업
      resourceNames : ["blue", "orange"]
    ```

### RoleBinding

+ 사용자의 Role을 설정하는 객체

+ Role, RolBinding 객체 → namespace 내에 생성됨

+ 특정 namespace 외의 자원에 대한 접근을 제한하고자 할 때에는 yaml 파일의 metadata 필드에 namespace를 지정해야 함

  + yaml 파일

    ```yaml
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
       name: devuser-developer-binding
    subjects:    # 사용자 세부 정보 지정
    - kind: User
      name: dev-user
      apiGroup: rbac.authorization.k8s.io
    roleRef:    # 생성한 역할 세부 정보 제공
      kind: Role
      name: developer
      apiGroup: rbac.authorization.k8s.io
    ```

  + 관련 명령어

    + RoleBinding 목록 : `kubectl get rolebindings` / `kubectl create rolebindig [role명] --namespace=[namespace명] --role=[role명] --user=[user명]`
    + RoleBinding 상세 조회 : `kubectl describe rolebindings [rolebinding명]`

### kubectl auth can-i

+ 클러스터에 접속한 사용자가 클러스터 내에서 허용된 작업을 확인할 때 사용하는 명령어
  + 관련 명령어
    + 허용된 작업 확인 : `kubectl auth can-i [verbs(작업)] [resources]` ex) `kubectl auth can-i create deployments`
    + 관리자/특정 사용자의 권한 확인 : `kubectl auth can-i [verbs] [resources] --as [user]` / `kubectl auth can-i [verbs] [resources] --as [ser] --namespace [namespace명]` ex) `kubectl auth can-i delete nodes --as dev-user`

<br/><br/>