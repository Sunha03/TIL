# 8-2. 네트워킹(Networking)

## DNS

<img src="https://user-images.githubusercontent.com/33214969/161440578-84cc6c6e-4d8f-4bac-8642-9c2ee7c5215a.png" alt="Network - DNS.png" width="50%;" />

+ 쿠버네티스는 클러스터를 set-up할 때, 기본적으로 내장 DNS 서버를 배포함
+ 클러스터 networking이 올바르게 설정되어 있으면 pod과 service는 각각 ip를 보유하고 서로 접속할 수 있음
+ service 생성 시, 쿠버네티스 DNS 서버는 service를 위한 record를 생성함 → service 이름 <-> ip 주소를 맵핑함 ⇒ 클러스터 내 모든 pod들은 service 이름을 통해 접근 가능함

### Domain name

<img src="https://user-images.githubusercontent.com/33214969/161440579-5b6db5c6-dabc-48a5-b49a-d0168b0bd580.png" alt="Network - DNS2.png" width="50%;" />

+ Service : `[service명].[namespace].svc.cluster.local`
+ Pod : `[pod ip + ‘-’].[namespace].pod.cluster.local`
  + svc : 모든 service가 그룹화된 subdomain

<br/>

## CoreDNS

+ 쿠버네티스 1.12버전부터 배포하는 DNS 서버

+ CoreDNS 서버는 쿠버네티스 클러스터의 kube-system namespace에 pod로 배포됨

+ CoreDNS는 Replicaset에 의해 2개의 pod로 배포됨

+ CoreDNS 설정 = Corefile 파일 → pod에 configmap으로 전달됨

  + 위치 : `cat /etc/coredns/Corefile`
  + 수 많은 plugin이 정의됨. ex) errors, health, metrics, cache, ...

  + kubernetes plugin = 클러스터의 최상위 도메인 이름(cluster.local)

    ```
    # /etc/coredns/Corefile
    .:53 {
    	errors
    	health
    	kubernetes cluster.local in-addr.arpa ip6.arpa {
    		pods insecure
    		upstream
    		fallthrough in-addr.arpa ip6.arpa
    	}
    	prometheus :9153
    	proxy . /etc/resolv/conf
    	cache 30
    	reload
    }
    ```

+ DNS 서버가 해결할 수 없는 레코드는 coredns pods의 `/etc/resolv.conf` 파일에 지정된 DNS 서버로 전송됨

+ `/etc/syslogv.conf` 파일 → 쿠보네티스 노드의 namespace를 사용하도록 설정되어 있음

+ CoreDNS pod에는 configMap 객체가 있음 → 설정을 변경해야할 경우, 이 configMap 객체를 변경해야 함

+ CoreDNS는 쿠버네티스 클러스터에서 새로운 pod or service를 감시 → pod or service 생성 시, DB에 해당 record를 추가함

### kube-dns

```tex
▫️ CoreDNS 솔루션을 배포할 때 생성되는, 다른 컴포넌트에서 사용할 수 있는 service
```

+ kube-dns service의 ip → pod에서 namespace로 구성되어 있음
+ pod의 DNS 구성 → pod 생성 시, 쿠버네티스에 의해 자동으로 생성됨
+ pod에 적절한 namespace를 설정하면 다른 pod or service와 연결할 수 있음
+ kubelet config file에서 DNS 서버 주소를 확인할 수 있음 → `/var/lib/kubelet/config.yaml`
+ 관련 명령어
  + DNS 솔루션 확인 : `kubectl get pods -n kube-system` → DNS pod 확인 / `kubectl get deployments -n kube-system`
  + DNS service 확인 : `kubectl get services -n kube-system` → DNS service 확인
  + configMap 파일 확인 : `kubectl get cm -n kube-system` + `kubectl describe cm coredns -n kube-system` / `kubectl describe deployment coredns -n kube-system`

<br/><br/>