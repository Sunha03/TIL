# 5. 클러스터 관리(Cluster Maintenance)

## OS 업그레이드(OS Upgrade)

+ SW 업그레이드 or security patch 등 노드를 내려야하는 경우

  + 노드가 `pod-eviction-timeout`(default : 5분) 안에 정상화되지 않으면 → pod 종료됨

    + `kube-controller-manager --pod-eviction-timeout=5m0s ...`

  + 단 5분 내로 노드가 복구되면 (kubelet에 의해) 해당 pod도 다시 뜸

  + replicaset의 pod의 경우 → 다른 노드에서 재생성됨 / 일반 pod일 경우 → 사라짐

    <img src="https://user-images.githubusercontent.com/33214969/161427053-e12a3ea7-7f23-4c98-824b-6cb43d9bceff.png" alt="OS 업데이트 - pod 종료-1.png" width="50%;" />

    <img src="https://user-images.githubusercontent.com/33214969/161427054-d9d79e33-6813-41c9-9edc-6d6cd1a6ac4c.png" alt="OS 업데이트 - pod 종료-2.png" width="50%;" />

### Drain 명령어

```tex
▫️ 해당 노드는 스케줄링에서 제외(unschedulable) + 해당 노드에 떠있는 pod들을 종료하고 다른 노드에 띄움
```

+ 이때 이동되는 pod들은 replicaset에 의해 생성된 pod 뿐만 아니라 모든 pod들이 해당됨

+ 노드/pod를 내려야 하는 경우에 사용함

  <img src="https://user-images.githubusercontent.com/33214969/161427051-e831a101-acc6-4d01-b8cd-1d4fc2e556bd.png" alt="OS 업데이트 - drain.png" width="50%;" />

+ drain 후 노드의 상태 : Ready, SchedulingDisabled

+ drain vs cordon

  + drain : 해당 노드를 스케줄링에서 제외 + 해당 노드에 떠있는 pod들을 종료하고 다른 노드에 띄움
  + cordon : 해당 노드를 스케줄링에서 제외 + 현재 떠있는 pod에 영향 없음 → 이후에 새롭게 생성되는 pod들이 이 노드에 스케줄링되지 X

### Uncordon 명령어

```tex
▫️ 노드 복구
```

+ 노드 작업이 끝난 후 `uncordon` 명령어를 통해 해당 노드를 클러스터로 복귀시킴 → 단 pod들은 되돌아오지 않음

  <img src="https://user-images.githubusercontent.com/33214969/161427045-de550830-6658-428e-8d21-10c25db7d844.png" alt="OS 업데이트 - 노드 업데이트.png" width="30%;" />

+ 관련 명령어

  + drain : 

    ```
    kubectl drain [node명]
    ```

    + (옵션) local data 모두 삭제 : `--delete-local-data`
    + (옵션) demonset을 무시하고 모두 삭제 : `--ignore-daemonsets`

  + uncordon : `kubectl uncordon [node명]`

<br/><br/>