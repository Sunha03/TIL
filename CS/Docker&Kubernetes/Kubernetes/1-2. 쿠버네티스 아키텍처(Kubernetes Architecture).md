# 1-2. 쿠버네티스 아키텍처(Kubernetes Architecture)

## 파드(Pods)

```tex
▫️ 쿠버네티스에서 생성하고 관리할 수 있는 배포 가능한 가장 작은 단위
```

+ 특징

  + 파드 = 하나 이상의 컨테이너 그룹 → 이 그룹은 스토리지/네트워크를 공유하고, 해당 컨테이너를 구동하는 방식에 대한 명세를 갖음
  + 파드의 콘텐츠(contents)들은 항상 함께 배치되고, 함께 스케줄 되며, 공유 콘텍스트(Context)에서 실행됨

+ 파드 생성 프로세스

  <img src="https://user-images.githubusercontent.com/33214969/161392135-cbb64270-92d8-4c6d-8842-1ab156f3cb0e.png" alt="파드 생성 프로세스.png" width="70%;" />

  (yaml 파일)

  ```yaml
  apiVersion: v1
  kind: Pod
  metadata:
    name: nginx
  spec:
    containers:
    - name: nginx
      image: nginx:1.19.2
  EOF
  ```

  ```bash
  $ kubectl apply -f Pod.yaml
  ```

  1. kubectl을 이용하여 yaml 파일을 kube-apiserver로 전달함
  2. kube-apiserver는 pod를 생성하는 요청을 받은 후, pod의 yaml 파일을 etcd로 저장함
  3. kube-scheduler는 kube-apiserver를 통해 pod 정보를 watch하고 있다가 → 새로운 pod가 등록된걸 감지하면 → pod를 실행 가능한 노드로 배치함
  4. etcd에 있는 pod의 정보에 배치될 노드의 정보를 추가 + kube-apiserver를 통해 정보를 업데이트
  5. kubectl은 자신의 노드에 배치된 파드의 정보를 감지 + 컨테이너를 실행 + kube-apiserver를 통해 상태 정보를 업데이트
  6. kube-apiserver는 업데이트된 정보를 다시 etcd에 저장함

+ IP 및 포트 관련

  + 동일한 파드 안의 컨테이너들은 동일한 네트워크 네임스페이스에서 실행됨<br/> → 동일 파드 안 컨테이너에서 실행중인 프로세스가 같은 포트 번호를 사용하지 않도록 주의해야 함
  + 파드 안에 있는 모든 컨테이너는 동일한 루프백 네트워크 인터페이스를 갖음<br/> → `localhost`를 통해 컨테이너들이 통신할 수 있음
  + 모든 pod는 다른 pod의 ip 주소를 사용하여 접근하는 것이 가능함

+ Pod에서 컨테이너를 사용하는 방법

  + pod는 특정한 애플리케이션만 호스팅함(한 호스트에 모든 유형의 애플리케이션을 넣지 않음)
  + 모든 것을 pod 1개에 넣는 대신<br/> → 애플리케이션을 여러 pod로 구성 + 각 pod에는 밀접하게 관련있는 구성 요소 or 프로세스만 포함해야 함
  + pod는 스케일링의 기본 단위임<br/> → 수평 확장(Scale out)을 위해 파드를 분리/배포하는 것이 필요함

+ Pod 관련 명령어

  + Pod 생성: `kubectl run (pod명) --image=(image명)` / `kubectl create -f (yaml 파일명).yaml`
  + Pod 수정 : `kubectl edit pod (pod명)` / `kubectl apply -f (yaml 파일명).yaml`
  + Pod의 yaml 파일 생성 : `kubectl get (pod명) -o yaml > (yaml명).yaml`
  + Pod 리스트 조회 + 자세히 조회(`-o` 옵션) : `kubectl get pods -o wide`
  + Pod 상세 조회 : `kubectl describe pods/(pod명)` / `kubectl describe pod (pod명)`
  + Pod 삭제 : `kubectl delete pod (pod명)`
  + Pod 로그 조회 : `kubectl logs (pod명)`

+ Pod 생성

  + yaml 파일

    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
    	name: nginx    # Pod 이름
    spec:
    	containers:    # 컨테이너를 만드는 컨테이너 이미지
    	- name: nginx  # 컨테이너 이름
    		image: nginx:1.14.2    # 이미지 이름
    		ports:
    		- containerPort: 80    # 애플리케이션이 수신하는 포트
    ```

  + 명령어

    ```bash
    $ kubectl create -f simple-pod.yaml
    
    # 파드의 전체 yaml 파일 조회
    $ kubectl get po simple-pod -o yaml
    
    # 파드 조회
    $ kubectl get pods
    
    # 로그 확인
    $ kubectl logs simple-pod
    
    # 컨테이너 지정 로그 확인
    $ kubectl logs simple-pod -c simple
    
    # 로컬 네트워크 포트를 파드의 포트로 포워딩
    # 로컬 포트 8080을 simple-pod Pod의 80 포트로 포워딩
    $ kubectl from 127.0.0.1:8080 -> 80
    ```

+ 특정 워커 노드에 Pod 올리는 방법 (nodeSelector)

  + 명령어

    ```bash
    # 노드 조회
    $ kubectl get nodes
    
    # 노드에 레이블 추가(CPU를 가지고 있는 노드만)
    $ kubectl label node gke-kubia gpu=true
    ```

  + yaml 파일

    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
    	name: nginx
    spec:
    	nodeSelector:    # nodeSelector : 쿠버네티스에 gpu=true 레이블을 포함한 노드에 해당 Pod를 배포하게 함
    		gpu: "true"
    	containers:
    	- name: nginx
    		image: nginx:1.14.2
    ```

### 레이블(Label)

```tex
▫️ pod를 정리하는 매커니즘. 어떤 pod인지 쉽게 알 수 있도록, 임의의 기준에 따라 작은 그룹으로 조직화하는 방법
```

+ yaml 파일

  ```yaml
  apiVersion: v1
  kind: Pod
  metadata:
  	name: nginx
  	labels:    # 2개의 레이블을 파드에 추가
  		creation_method: manual
  		env: dev
  spec:
  	containers:
  	- name: nginx
  		image: nginx:1.14.2
  		ports:
  		- containerPort: 80
  ```

+ 명령어

  ```shell
  # --show-labels : 레이블 확인
  $ kubectl get po --show-labels
  
  # 특정 레이블을 자체 열에 표시
  # kubectl get po -L (레이블 이름)
  $ kubectl get po -L creation_method, env
  
  # 레이블 추가
  # kubectl label po (pod명) (레이블 이름)=(레이블 값)
  $ kubectl label po simple-pod creation_method=manual
  
  # 레이블 수정
  # kubectl label po (pod명) (레이블 이름)=(레이블 값) --overwrite
  $ kubectl label po simple-pod env=prd --overwrite
  
  # 특정 레이블의 pod를 조회
  $ kubectl get po -l creation_method=manual
  $ kubectl get po -l env
  $ kubectl get po -l '!env'
  ```

<br/><br/>파드<br/>[참고] https://pearlluck.tistory.com/136<br/>[참고] https://bluayer.com/41