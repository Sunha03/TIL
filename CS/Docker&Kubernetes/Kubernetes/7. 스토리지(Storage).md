# 7. 스토리지(Storage)

## Docker Storage

### Storage Drivers

+ File system → /var/lib/docker/containers,image,volumes 에 default로 도커 데이터를 저장함
+ Volume Mount : `docker volume create date_volume` → /var/lib/docker/volumes/data_volume에 volume이 생성됨
+ volume을 도커 컨테이너 내에 mount : `docker run -v data_volume:/var/lib/mysql mysql` → mysql 컨테이너 내에 /var/llib/mysql 폴더로 마운트됨 → `-v` 옵션 :  `docker run`할 때 volume을 생성하지 않아도 해당 이름의 volume이 자동으로 생성됨
+ Bind Mount : `docker run -v /data/mysql:/var/lib/mysql mysql` / `docker run --mount type=bind, source=/data/mysql, target=/var/lib/mysql mysql` → Host에 존재하는 폴더를 컨테이너 내부로 mount
+ Storage driver의 역할 - 도커의 operation, layered 구조 유지, writable layer 생성, ...
+ ex) AUFS, ZFS, BTRFS, Device Mapper Overlay, Overlay2, ...

### Volume Driver

+ Volume Driver의 역할 - volume을 다룸
+ 기본적인 volume plugin : local volume plugin
  + local volume plugin이 host에 volume을 생성 + 데이터를 저장
  + 그 외 3rd party volume driver를 사용해도 됨 ex) Azure File Storage, Convoy, Digital Ocean Block, ...
+ driver 지정 : `docker run --volume-driver`

### Container Storage Interface

+ CRI(Container Runtime Interface) : 쿠버네티스 같은 솔루션이 도커와 같은 container runtime 솔루션과 소통하는지 정의하는 기준
+ CNI(Container Network Interface) : 네트워크 인터페이스로 CNI를 지킴으로써 쿠버네티스와 작동할 수 있는 네트워크 플러그인을 개발할 수 있음
+ CSI(Container Storage Interface) : 여러 storage 솔루션을 위한 인터페이스

<br/>

## Volumes

```tex
▫️ pod에 종속되는 디스크(=컨테이너의 외장디스크)
```

### Volume in Docker

+ 도커 컨테이너는 데이터 처리가 필요할 때 요청 + 처리 완료 후에는 삭제됨 → 이때, 컨테이너 내의 데이터도 함께 삭제됨 → 이 데이터들을 유지하기 위해서 volume을 설정하여 사용
+ volume을 설정 → 컨테이너에서 처리한 데이터가 volume에 저장됨 ⇒ 컨테이너 삭제 후에도 데이터 유지 가능함

### Volume in Kubernetes

<img src="https://user-images.githubusercontent.com/33214969/161439916-43a7b18b-0795-42b5-bf05-0acbffdb9160.png" alt="Storage - Volume.png" width="30%;" />

+ 쿠버네티스 pod 역시 데이터 처리한 뒤 삭제됨 → 이때 처리한 데이터도 함께 삭제됨

+ volume을 설정 → pod에서 처리한 데이터가 volume에 저장됨 ⇒ pod 삭제 후에도 데이터 유지 가능함

+ Volume 구성 방법

  + Host Path

    + Host 디렉토리를 사용하는 방법 → volume 내에서 생성된 파일이 Host 디렉토리에 저장됨

    + volume 생성 후 컨테이너에서 볼륨을 접근할 수 있도록 컨테이너 내의 디렉토리에 마운트(volumeMount)를 해야 함

    + yaml 파일

      ```yaml
      apiVersion: v1
      kind: Pod
      metadata:
        name: random-number-generator
      spec:
        containers:
        - image: alpine
          name: alpine
          command: ["/bin/sh", "-c"]
          args: ["shuf -i 0-100 -n 1 >> /opt/number.out;"]
          volumeMounts:  # volume을 mount
          - mountPath: /opt  # volume mount : volume 생성 path
            name: data-volume
        volumes:
        - name: data-volume
          hostPath:
            path: /data    # volume host path
            type: Directory
      ```

  + 외부 클러스터 스토리지 솔루션

    + 스토리지 솔루션 : NFS, glusterFS, Flocker, FibreChannel, ...

    + 클러스터 솔루션 : AWS EBS, Azure Disk, Azure File, Google’s Persistent Disk

      + ex) AWS EBS

        ```yaml
        ...
          volumes:
          - name: data-volume
            awsElasticBlockStore:
              volumeID: [volume id]
              fsType: ext4
        ...
        ```

<br/>

## 퍼시스턴트 볼륨(PV, Persistent Volumes)

```tex
▫️ 관리자에 의해 생성된 클러스터 전체의 storage volume pool
```

<img src="https://user-images.githubusercontent.com/33214969/161439900-cbc82b5e-67f2-46eb-86a3-8f47eaa4c4d1.png" alt="Storage - PV.png" width="50%;" />

+ 특징

  + Storage 중앙 관리용
  + 클러스터에서 애플리케이션을 배포하는 사용자가 사용함
  + 사용자는 PVC(Persistent Volumes Claims)를 사용하여 pool에서 storage를 선택함

+ PV 생성 방법(yaml 파일)

  + accessModes : host에서 volume을 마운트하는 방법 ex) ReadWriteOnce | ReadOnlyMany | ReadWriteMany
  + capacity : storage 용량 설정
  + hostPath : volume 유형

  + 단, AWS EBS 사용 시, `awsElasticBlockStore`으로 대체해야 함

  ```yaml
  # pv-definition.yaml
  apiVersion: v1
  kind: PersistentVolume
  metadata:
    name: pv-vol1
  spec:
    accessModes:
      - ReadWriteOnce  # ReadWriteOnce|ReadOnlyMany|ReadWriteMany
    capacity:    # 예약할 storage 용량
      storage: 1Gi
    hostPath:
      path: /tmp/data
    gcePersistentDisk:
      pdName: pd-disk
      fsType: ext4
    persistentVolumeReclaimPolicy: Retain
  ```

+ 관련 명령어

  + PV 생성 : `kubectl create -f [PV yaml 파일명].yaml`
  + PV 조회 : `kubectl get persistentvolume` / `kubectl get pv`

<br/><br/>