# 4. 라이프사이클(Lifecycle)

## 롤링 업데이트(Rolling Updates) & 롤백(Rollbacks)

+ deployment는 rollout을 트리거하고, 새 rollout은 새 deployment revision을 생성함

+ deployment 생성 후 수정한 경우(ex. 도커 업데이트, ...) → 새로운 revision이 생김

+ 이러한 revision들로 인해 변경을 추적 가능함 + 문제 발생 시, 이전 revision으로 rollback할 수 있음

+ Deployment 업데이트 방식 2가지

  1. yaml 파일 수정 + `kubectl apply -f [yaml 파일명].yaml` → 새로운 rollout 생성 or `kubectl edit deployment [deploy명]`
  2. 명령어로 업데이트 → ex) `kubectl set image deployment/myapp-deploymtn nginx=nginx:1.9.1` → 업데이트는 되지만, deployment를 정의한 파일은 수정되지 않음

+ Deployment 배포 종류

  ### Recreate

  + 기존 pod를 전부 내리고, 새로운 pod를 올림 → 새로운 pod가 뜨기 전까지 서비스가 불가능함

  + yaml 파일

    ```yaml
    #deployment-definition.yaml
    ...
    spec:
    	strategy:
    		type: Recreate
    ...
    ```

  ### 롤링 업데이트(RollingUpdate)

  + pod를 하나씩 내리고 올림 → 서비스 중단 없음

  + 동작방식

    1. 새로운 deployment 생성 → 그에 따른 replicaset 생성됨
    2. deployment 수정 → 이에 맞는 새로운 replicaset이 생성됨
    3. 이전 replicaset에서 pod를 1개씩 내리며 새로운 replicaset에서 pod를 하나씩 생성하며 교체함

    <img src="https://user-images.githubusercontent.com/33214969/161425832-b73502bd-7696-44ba-ae07-2254b950561f.png" alt="라이프사이클 - Recreate&RollingUpdate.png" width="50%;" />

  + yaml 파일

    ```yaml
    #deployment-definition.yaml
    ...
    spec:
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 25%    # 업데이트 중 사용할 수 없는 최대 pod 개수 지정
          maxSurge: 25%    # 의도한 pod 수에 대해 생성할 수 있는 최대 pod 개수 지정
    ...
    ```

### 롤백(Rollback)

+ 새로운 deployment에 문제가 있어서 이전 revision으로 되돌리고 싶은 경우 롤백을 사용함
+ 관련 명령어
  + 롤아웃 조회 : `kubectl rollout status deploy [deploy명]`
  + 롤아웃 히스토리 정보 조회 : `kubectl rollout history deploy [deploy명]`
  + 롤백 : `kubectl rollback undo deploy [deploy명]`

<br/><br/>

[참고] https://nopanderer.github.io/kubernetes/2021-07-28-lifecycle/<br/>[참고] https://kdeon.tistory.com/66?category=911987<br/>