# 도커(Docker)

```tex
▫️ 컨테이너 기반의 오픈소스 가상화 플랫폼
```

+ 특징
  + 컨테이너형 가상화 기술을 구현하기 위한 상주 애플리케이션 + 이 애플리케이션을 조작하기 위한 명령행 도구(Docker CLI)로 구성되어 있음
  + 도커를 사용하면 애플리케이션을 인프라에서 분리 가능함 → SW를 빠르게 제공 가능함
  + 도커를 사용하면 애플리케이션을 관리하는 것과 동일한 방식으로 인프라 관리가 가능함
  + 프로덕션 환경에서 코드 작성과 실행 사이의 지연을 크게 줄일 수 있음
  + 도커를 사용하면 애플리케이션 배포를 굉장히 쉽게할 수 있기 때문에 애플리케이션 개발 및 운영을 컨테이너 중심으로 할 수 있음
  + 주어진 하나의 Host OS 안에서 여러 컨테이너를 동시에 실행할 수 있음
  + 컨테이너의 라이프 사이클을 관리 + 애플리케이션을 오케스트레이션(Work flow의 자동화)된 서비스로 배포할 수 있음
+ 장점
  + 속도가 빠르고 가벼움
  + 쉽고 빠르게 동일한 환경 구축 가능
  + 관리가 편함
  + 배포가 쉬움
+ 사용하는 경우
  + 빠르고 일관된 애플리케이션 제공<br/>- CI/CD의 work flow에 적합
  + 반응형 배포 및 확장<br/>- 이식성이 높은 워크로드에 적합
  + 동일한 하드웨어에서 더 많은 워크로드 실행<br/>- 고밀도 환경과 더 적은 리소스로 더 많은 작업을 수행해야 하는 중소 배포에 적합

<br/>

## 도커 아키텍처

<img src="https://user-images.githubusercontent.com/33214969/150668818-1f85a81d-5859-4df3-befc-ce65f2439b6c.png" alt="도커 아키텍처.png" width="70%;" />

+ 도커는 Client-Server 아키텍처를 사용함
+ 도커 클라이언트는 Docker 컨테이너를 빌드, 실행 및 배포하는 Docker 데몬과 통신함
+ 도커 클라이언트와 데몬은 UNIX 소켓 or 네트워크 인터페이스를 통해 REST API를 사용하여 통신함
+ 도커 컴포즈는 컨테이너 세트로 구성된 애플리케이션으로 작업할 수 있는 또 다른 도커 클라이언트임

* 도커 데몬(Docker Deamon, dockerd)<br/>- 도커 API 요청을 수신<br/>- 이미지, 컨테이너, 네트워크와 같은 도커 객체 및 도커 서비스 관리<br/>- 도커 서비스를 관리하기 위해 다른 데몬과 통신할 수 있음

* 도커 클라이언트(Docker Client)<br/>- 도커 사용자가 도커와 상호작용하기 위한 방법<br/>- 기본적인 도커 명령어를 통해 Docker 데몬과 통신<br/>- 도커 클라이언트는 둘 이상의 데몬과 통신할 수 있음

* 도커 데스크탑(Docker Desktop)<br/>- 컨테이너화된 애플리케이션과 마이크로서비스를 구축하고 공유할 수 있는 Mac or Windows 환경용으로 설치하기 쉬운 애플리케이션<br/>- 도커 데스크탑에는 도커 데몬 / 도커 클라이언트 / 도커 컴포즈 / 도커 content trust / 쿠버네티스 / Credential Helper가 포함됨

* 도커 레지스트리(Docker Registry)<br/>- 도커 이미지를 저장<br/>- 도커 허브(Docker Hub)라는 공용 레지스트리와 private한 레지스트리가 있음<br/>- 일반적으로 공용 레지스트리에서 실행함<br/>- `docker pull` or  `docker run` : 레지스트리에서 필요한 이미지를 가져옴<br/>- `docker push` : 이미지를 레지스트리로 푸시

* 도커 객체<br/>- 도커 이미지 / 도커 컨테이너 / ...

<br/>

<img src="https://user-images.githubusercontent.com/33214969/150668988-38756e2c-1c36-4eec-bccc-dc72c60ef267.png" alt="도커파일.png" width="70%;" />

## 도커파일(Dockerfile)

```tex
▫️ 컨테이너에 설치해야 하는 패키지, 소스코드, 명령어, 환경변수 설정 등을 기록한 하나의 파일
```

+ 특징
  + 도커파일을 빌드 → 이미지 생성됨
  + 도커파일을 이용해 애플리케이션 빌드 및 배포를 자동화할 수 있음
+ 장점
  + 이미지가 어떻게 만들어졌는지 기록함
  + 배포에 용이함
  + 컨테이너(이미지)가 특정 행동을 수행하도록 함

### 도커파일 작성 & 인스트럭션(Instruction)

+ 도커파일명은 “Dockerfile”로 해야함

+ 인스트럭션(Instruction) = 명령어

  | 명령어     | 설명                                                         | 예제                                                         |
  | ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | FROM       | 베이스 이미지를 지정<br/> - 반드시 1번 이상 입력해야 함<br/> - 태그 : 각 이미지 버전 등을 구별하는 식별자 ex)latest | `FROM golang:1.9`                                            |
  | RUN        | 이미지 내부에서 실행할 명령어를 정의 & 새로운 이미지 생성<br/> - 이미지가 빌드할 때 실행됨 → 업데이트/배치할 때 사용<br/> - RUN 명령을 실행할 때마다 레이어가 생성&캐시됨 | `RUN mkdir /echo`                                            |
  | CMD        | 컨테이너가 시작될 때마다 실행할 명령어<br/> - Dockerfile에서 1번만 실행됨 → 애플리케이션 자체를 실행할 때 사용<br/> - docker run으로 컨테이너 생성할 때 or docker start으로 정지된 컨테이너를 시작할 때 실행됨<br/> - 보통 컨테이너 내부에서 항상 돌아가야하는 서버를 띄울 때 사용함 | `CMD ["go", "run", "/echo/main.go"]` = `$ go run /echo/main.go` |
  | LABEL      | 라벨 설정<br/> - 이미지에 메타 데이터를 추가함<br/> - 나중에 원하는 조건의 이미지/컨테이너 등을 쉽게 찾을 수 있도록 도와줌<br/> - key-value 형태 |                                                              |
  | EXPOSE     | 이미지에서 노출할 포트를 지정                                | `EXPOSE 8917`                                                |
  | ENV        | 컨테이너의 환경변수를 지정                                   |                                                              |
  | ADD        | 이미지 생성 시, 파일/디렉토리 추가<br/> - Host 머신의 파일/디렉토리를 이미지에 추가 | `ADD file /dir1/file1`                                       |
  | COPY       | 이미지 생성 시, 파일 복사<br/> - Host 머신의 파일/디렉토리를 이미지에 복사 | `COPY main.go /echo`                                         |
  | ENTRYPOINT | 컨테이너 시작할 때 실행할 명령어                             |                                                              |
  | WORKDIR    | 명령어를 실행할 디렉토리 지정<br/> - bash shell에서의 cd 명령어와 동일함 | `WORKDIR /var/dir1`                                          |
  
  | 명령어      | 설명                                                         | 예제                                      |
  | ----------- | ------------------------------------------------------------ | ----------------------------------------- |
  | MAINTAINER  | 이미지 작성자 명시<br/> - 보통 이미지 or 닉네임을 명시<br/> - 1.13.0 이후 사용 X | `MAINTAINER James, tom <tom03@gmail.com>` |
  | VOLUMN      | 컨테이너의 볼륨을 지정                                       |                                           |
  | USER        | 컨테이너의 사용자를 지정                                     |                                           |
  | ARG         | Dockerfile 안의 변수                                         |                                           |
  | ONBUILD     | 빌드 완료 후 실행되는 명령어                                 |                                           |
  | STOPSIGNAL  | 시스템 콜 시그널 설정                                        |                                           |
  | HEALTHCHECK | 컨테이너의 health check                                      |                                           |
  | SHELL       | 기본 shell 설정                                              |                                           |
  
  